# ğŸ“± Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Pattern ÙˆØ§Ø­Ø¯ Ø¨Ø±Ø§ÛŒ OTP Ùˆ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ

## ğŸ¯ Ù‡Ø¯Ù

Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Pattern Ø¯Ø± MeliPayamak Ú©Ù‡ Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ú©Ø¯ OTP Ùˆ Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ (Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§) Ú©Ø§Ø± Ú©Ù†Ø¯.

---

## ğŸ“‹ Ù…Ø±Ø§Ø­Ù„

### Ù…Ø±Ø­Ù„Ù‡ 1: Ø«Ø¨Øª Pattern Ø¯Ø± MeliPayamak

#### Ú¯Ø²ÛŒÙ†Ù‡ 1: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø³Ú©Ø±ÛŒÙ¾Øª (ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)

```bash
python create_universal_pattern.py
```

Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª:
- 3 Pattern Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
- Pattern Ø±Ø§ Ø¯Ø± MeliPayamak Ø«Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
- Pattern ID Ø±Ø§ Ø¨Ù‡ Ø´Ù…Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯

#### Ú¯Ø²ÛŒÙ†Ù‡ 2: Ø«Ø¨Øª Ø¯Ø³ØªÛŒ Ø¯Ø± Ù¾Ù†Ù„ MeliPayamak

1. ÙˆØ§Ø±Ø¯ Ù¾Ù†Ù„ MeliPayamak Ø´ÙˆÛŒØ¯: https://panel.payamak-panel.com/
2. Ø¨Ù‡ Ø¨Ø®Ø´ **"Ø§Ù„Ú¯ÙˆÙ‡Ø§"** ÛŒØ§ **"Patterns"** Ø¨Ø±ÙˆÛŒØ¯
3. Ø±ÙˆÛŒ **"Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù„Ú¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯"** Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯
4. Pattern Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ† ØµÙˆØ±Øª Ø«Ø¨Øª Ú©Ù†ÛŒØ¯:

**Ø¹Ù†ÙˆØ§Ù† Pattern:**
```
Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ Ø²ÛŒØ³ØªÛŒÙ†Ùˆ
```

**Ù…ØªÙ† Pattern:**
```
{0}
```

**ØªÙˆØ¶ÛŒØ­Ø§Øª:**
- `{0}` Ø¨Ù‡ Ù…Ø¹Ù†Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù† Ø§Ø³Øª
- Ø§ÛŒÙ† Pattern Ø³Ø§Ø¯Ù‡â€ŒØªØ±ÛŒÙ† Ø­Ø§Ù„Øª Ø§Ø³Øª Ùˆ Ù‡Ø± Ù…ØªÙ†ÛŒ Ø±Ø§ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ø¯
- Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù‡Ù… Ú©Ø¯ OTP Ø¨Ø§Ø´Ø¯ Ùˆ Ù‡Ù… Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ

5. Pattern Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯ Ùˆ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ø¨Ù…Ø§Ù†ÛŒØ¯ (Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ 1-2 Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ)

---

### Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±ÛŒØ§ÙØª Pattern ID

Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Pattern:
1. Ø¯Ø± Ù„ÛŒØ³Øª Pattern Ù‡Ø§ØŒ ID Pattern Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ `123456`)
2. Ø§ÛŒÙ† ID Ø±Ø§ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ú©Ù†ÛŒØ¯

---

### Ù…Ø±Ø­Ù„Ù‡ 3: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ .env

ÙØ§ÛŒÙ„ `.env` Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:

```env
MELIPAYAMAK_PATTERN_ID=123456
```

(Ø¹Ø¯Ø¯ `123456` Ø±Ø§ Ø¨Ø§ Pattern ID Ø®ÙˆØ¯ØªØ§Ù† Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯)

Ù‡Ù…Ú†Ù†ÛŒÙ† Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ù‡ Ø§ÛŒÙ† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡Ù… ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯:

```env
MELIPAYAMAK_USERNAME=09155009664
MELIPAYAMAK_API_KEY=f2b89fd9-5633-4623-92c1-b3a896639f76
```

---

### Ù…Ø±Ø­Ù„Ù‡ 4: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø¯

âš ï¸ **Ù…Ù‡Ù…:** Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ ÙØ§ÛŒÙ„ `sms_service.py` Ø±Ø§ restore Ú©Ù†ÛŒØ¯ (Ø¨Ù‡ ÙØ§ÛŒÙ„ `RESTORE_SMS_SERVICE.md` Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯).

Ø¨Ø¹Ø¯ Ø§Ø² restoreØŒ ØªØ§Ø¨Ø¹ `send_universal_pattern_sms` Ø±Ø§ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ `sms_service.py` Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:

```python
def send_universal_pattern_sms(phone_number, message):
    """
    Ø§Ø±Ø³Ø§Ù„ SMS Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Pattern ÙˆØ§Ø­Ø¯ Ú©Ù‡ Ù‡Ù… Ø¨Ø±Ø§ÛŒ OTP Ùˆ Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    """
    try:
        pattern_id = settings.MELIPAYAMAK_PATTERN_ID
        
        if not pattern_id:
            error_msg = "MELIPAYAMAK_PATTERN_ID not configured in settings."
            logger.error(error_msg)
            return False, error_msg
        
        try:
            pattern_id_int = int(pattern_id)
        except (ValueError, TypeError):
            error_msg = f"Invalid MELIPAYAMAK_PATTERN_ID: {pattern_id}. Must be a number."
            logger.error(error_msg)
            return False, error_msg
        
        # Pattern ÙÙ‚Ø· ÛŒÚ© Ù…ØªØºÛŒØ± Ø¯Ø§Ø±Ø¯: {0}
        pattern_args = [message]
        
        logger.info(f"Sending SMS via universal pattern {pattern_id_int} to {phone_number}")
        logger.info(f"Message: {message}")
        
        return send_sms_with_pattern(
            phone_number=phone_number,
            pattern_id=pattern_id_int,
            pattern_args=pattern_args
        )
        
    except Exception as e:
        error_msg = f"Unexpected error in send_universal_pattern_sms: {str(e)}"
        logger.error(error_msg)
        import traceback
        logger.error(f"Traceback: {traceback.format_exc()}")
        return False, error_msg
```

---

### Ù…Ø±Ø­Ù„Ù‡ 5: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ú©Ø¯

#### Ø¨Ø±Ø§ÛŒ OTP (Ù„Ø§Ú¯ÛŒÙ†):

Ø¯Ø± `authentication/views.py`:

```python
from zistino_apps.payments.sms_service import send_universal_pattern_sms

# Ø¯Ø± SendCodeView:
sms_success, sms_error = send_universal_pattern_sms(phone_number, code)
```

#### Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§:

Ø¯Ø± `compatibility/notifications/views.py`:

```python
from zistino_apps.payments.sms_service import send_universal_pattern_sms

# Ø¯Ø± NotificationSendView:
sms_success, sms_error = send_universal_pattern_sms(phone_number, message)
```

---

### Ù…Ø±Ø­Ù„Ù‡ 6: Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª Ø³Ø±ÙˆØ±

```bash
# Stop server (Ctrl+C)
# Then restart:
python manage.py runserver
```

---

### Ù…Ø±Ø­Ù„Ù‡ 7: ØªØ³Øª

#### ØªØ³Øª OTP:
```bash
curl -X POST http://127.0.0.1:8000/api/v1/auth/send-code/ \
  -H "Content-Type: application/json" \
  -d '{"phone_number": "09017021166"}'
```

#### ØªØ³Øª Ø§Ø¹Ù„Ø§Ù†:
```bash
curl -X POST http://127.0.0.1:8000/api/v1/notifications/send \
  -H "Content-Type: application/json" \
  -H "Authorization: Token YOUR_TOKEN" \
  -d '{
    "phoneNumber": "09017021166",
    "message": "Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯"
  }'
```

---

## âœ… Ù…Ø²Ø§ÛŒØ§ÛŒ Pattern ÙˆØ§Ø­Ø¯

- âœ… ÛŒÚ© Pattern Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯ (OTP Ùˆ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§)
- âœ… Ø³Ø§Ø¯Ù‡ Ùˆ Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±
- âœ… Ø§Ø±Ø²Ø§Ù†â€ŒØªØ± Ø§Ø² Ù¾ÛŒØ§Ù…Ú© Ø¢Ø²Ø§Ø¯
- âœ… ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ØªØ±
- âœ… Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø´Ù…Ø§Ø±Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡

---

## âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…

1. **Pattern Ø¨Ø§ÛŒØ¯ ØªØ§ÛŒÛŒØ¯ Ø´ÙˆØ¯:** ØªØ§ Pattern ØªØ§ÛŒÛŒØ¯ Ù†Ø´ÙˆØ¯ØŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
2. **Pattern ID Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯:** Ø¨Ø¹Ø¯ Ø§Ø² Ø«Ø¨Øª PatternØŒ ID Ø±Ø§ Ø¯Ø± `.env` Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
3. **ØªØ³Øª Ú©Ù†ÛŒØ¯:** Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ PatternØŒ Ø­ØªÙ…Ø§Ù‹ ØªØ³Øª Ú©Ù†ÛŒØ¯

---

## ğŸ” Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ

**Ø§Ú¯Ø± Pattern Ú©Ø§Ø± Ù†Ú©Ø±Ø¯:**
1. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Pattern ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª
2. Pattern ID Ø±Ø§ Ø¯Ø± `.env` Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯
3. Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯

**Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ÙÛŒØ¯:**
```
Sending SMS via universal pattern 123456 to 09017021166
Message: 123456
```

---

## ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ

Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø§Ø´ØªÛŒØ¯:
1. Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯
2. Pattern ID Ø±Ø§ Ø¯Ø± Ù¾Ù†Ù„ MeliPayamak Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯
3. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Pattern ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª

